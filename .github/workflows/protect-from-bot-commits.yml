name: Protect Against Bot Commits

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

jobs:
  check-bot-commits:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 10
        
    - name: Check for Unauthorized Bot Commits
      run: |
        echo "ðŸ” Verificando commits nÃ£o autorizados de bots..."
        
        # Lista de bots que NÃƒO devem fazer commits
        FORBIDDEN_BOTS="coderabbitai|coderabbit|claude-code"
        
        # Verificar Ãºltimos commits
        git log --oneline -10 --pretty=format:"%h %an %s" > recent_commits.txt
        
        # Verificar se hÃ¡ commits de bots proibidos
        if grep -iE "$FORBIDDEN_BOTS" recent_commits.txt; then
          echo "ðŸš¨ ERRO: Commit nÃ£o autorizado detectado de bot!"
          echo "ðŸ“‹ Commits encontrados:"
          grep -iE "$FORBIDDEN_BOTS" recent_commits.txt
          echo ""
          echo "âŒ CodeRabbit e outros bots de revisÃ£o NÃƒO devem fazer commits"
          echo "âœ… Apenas Gemini Code Assist pode fazer commits de formataÃ§Ã£o"
          echo ""
          echo "ðŸ”§ AÃ§Ãµes necessÃ¡rias:"
          echo "1. Reverter commits nÃ£o autorizados"
          echo "2. Verificar configuraÃ§Ãµes do bot"
          echo "3. Revisar permissÃµes do repositÃ³rio"
          exit 1
        else
          echo "âœ… Nenhum commit nÃ£o autorizado detectado"
        fi
        
    - name: Verify Author Information
      if: github.event_name == 'push'
      run: |
        echo "ðŸ“§ Verificando informaÃ§Ãµes do autor do Ãºltimo commit..."
        
        LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        LAST_COMMIT_EMAIL=$(git log -1 --pretty=format:"%ae")
        
        echo "Autor: $LAST_COMMIT_AUTHOR"
        echo "Email: $LAST_COMMIT_EMAIL"
        
        # Verificar se o commit Ã© de um bot nÃ£o autorizado
        if echo "$LAST_COMMIT_EMAIL" | grep -iE "coderabbit|claude-code"; then
          echo "ðŸš¨ ALERTA: Commit de bot nÃ£o autorizado detectado!"
          echo "ðŸ“§ Email suspeito: $LAST_COMMIT_EMAIL"
          
          # Notificar no PR se existir
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "commit_warning=true" >> $GITHUB_OUTPUT
          fi
        fi